
{% extends 'base.html' %}
{% load dict_extras %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container my-5">

    <h1 class="mb-4 fw-bold text-primary display-5">
        <i class="bi bi-speedometer2"></i> Admin Dashboard
    </h1>

    <!-- ========== STAT SUMMARY CARDS ========== -->
    <div class="row g-4 mb-5">
        <div class="col-6 col-md-3">
            <div class="card border-maroon shadow h-100 text-center border-2">
                <div class="card-body">
                    <div class="fs-1 fw-bold text-maroon mb-2">
                        <i class="bi bi-people"></i> {{ total_users }}
                    </div>
                    <div class="text-muted mb-2">Total Students</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-primary shadow h-100 text-center border-2">
                <div class="card-body">
                    <div class="fs-1 fw-bold text-primary mb-2">
                        <i class="bi bi-book"></i> {{ total_lessons }}
                    </div>
                    <div class="text-muted">Lessons</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-info shadow h-100 text-center border-2">
                <div class="card-body">
                    <div class="fs-1 fw-bold text-info mb-2">
                        <i class="bi bi-question-circle"></i> {{ total_quizzes }}
                    </div>
                    <div class="text-muted">Quizzes</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-danger shadow h-100 text-center border-2">
                <div class="card-body">
                    <div class="fs-1 fw-bold text-danger mb-2">
                        <i class="bi bi-clipboard-check"></i> {{ total_exams }}
                    </div>
                    <div class="text-muted">Exams</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== STUDENTS GRADES CARD ========== -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-maroon shadow-lg rounded-4 mb-5">
                <div class="card-header bg-white border-bottom-0 pb-0 rounded-top-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <i class="bi bi-bar-chart-fill fs-2 text-maroon"></i>
                            <h4 class="fw-bold m-0 text-maroon" style="font-size: 2rem;">
                                Students Grades
                            </h4>
                        </div>
                        <p class="mb-0 text-muted small">Summarized grades â€“ weighted 40% quizzes, 60% exams</p>
                    </div>
                    <div class="d-flex gap-2 mt-3 mt-md-0 flex-wrap">
                                    <button id="downloadExcelBtn" class="btn btn-success btn-sm" type="button">
                                        <i class="bi bi-file-earmark-excel"></i> Download as Excel
                                    </button>
                                    <button id="downloadDocBtn" class="btn btn-primary btn-sm" type="button">
                                        <i class="bi bi-file-earmark-word"></i> Download as Docs
                                    </button>
                    </div>
                </div>
                <div class="card-body pt-3 pb-4">

                    <form id="students-grades-filter-form" class="row g-2 mb-3 align-items-end" method="get" autocomplete="off">
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Grading Period</label>
                            <select name="grading_period" class="form-select">
                                <option value="overall"{% if selected_period == 'overall' %} selected{% endif %}>Overall</option>
                                {% for period in grading_periods %}
                                    <option value="{{ period.0 }}"{% if period.0 == selected_period %} selected{% endif %}>{{ period.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Section</label>
                            <select name="section" class="form-select">
                                {% for sec in section_choices %}
                                    <option value="{{ sec.0 }}"{% if sec.0 == selected_section %} selected{% endif %}>{{ sec.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1 visually-hidden">Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search student name..." name="search" value="{{ search_query|default_if_none:'' }}">
                                <button class="btn btn-secondary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const form = document.getElementById('students-grades-filter-form');
                        const tableBody = document.querySelector('#students-grades-table tbody');
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            const formData = new FormData(form);
                            fetch(window.location.pathname + '?ajax=1&table=students_grades&' + new URLSearchParams(formData), {
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            })
                            .then(response => response.text())
                            .then(html => { tableBody.innerHTML = html; });
                        });
                        form.querySelectorAll('select, input').forEach(el => {
                            el.addEventListener('change', function() {
                                form.dispatchEvent(new Event('submit'));
                            });
                        });
                        // Sorting
                        let currentSort = form.querySelector('input[name="sort"]') ? form.querySelector('input[name="sort"]').value : '';
                        let currentDir = form.querySelector('input[name="dir"]') ? form.querySelector('input[name="dir"]').value : 'asc';
                        document.querySelectorAll('#students-grades-table th.sortable').forEach(function(th) {
                            th.style.cursor = 'pointer';
                            th.addEventListener('click', function() {
                                const sortField = th.getAttribute('data-sort');
                                let dir = 'asc';
                                if (currentSort === sortField && currentDir === 'asc') dir = 'desc';
                                let sortInput = form.querySelector('input[name="sort"]');
                                let dirInput = form.querySelector('input[name="dir"]');
                                if (!sortInput) {
                                    sortInput = document.createElement('input');
                                    sortInput.type = 'hidden';
                                    sortInput.name = 'sort';
                                    form.appendChild(sortInput);
                                }
                                if (!dirInput) {
                                    dirInput = document.createElement('input');
                                    dirInput.type = 'hidden';
                                    dirInput.name = 'dir';
                                    form.appendChild(dirInput);
                                }
                                sortInput.value = sortField;
                                dirInput.value = dir;
                                currentSort = sortField;
                                currentDir = dir;
                                form.dispatchEvent(new Event('submit'));
                            });
                        });
                    });
                    </script>

                    <div class="table-responsive">
                        <table id="students-grades-table" class="table table-hover table-bordered align-middle rounded-4 shadow-sm overflow-hidden">
                            <thead class="text-center rounded-top-4">
                                <tr class="fw-semibold text-maroon bg-light">
                                    <th class="bg-white rounded-start-3 sortable" data-sort="section">Section <span class="sort-arrows">{% if sort == 'section' %}{% if dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="bg-white sortable" data-sort="full_name">Name <span class="sort-arrows">{% if sort == 'full_name' %}{% if dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="bg-white sortable" data-sort="quiz_grade">Quiz Grade (40%) <span class="sort-arrows">{% if sort == 'quiz_grade' %}{% if dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="bg-white sortable" data-sort="exam_grade">Exam Grade (60%) <span class="sort-arrows">{% if sort == 'exam_grade' %}{% if dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="bg-white sortable" data-sort="grade">Grade (40+60) <span class="sort-arrows">{% if sort == 'grade' %}{% if dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="bg-white rounded-end-3 sortable" data-sort="gpa">GPA <span class="sort-arrows">{% if sort == 'gpa' %}{% if dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if students_grades %}
                                {% for stu in students_grades %}
                                <tr class="text-center align-middle">
                                    <td class="fw-medium">{{ stu.section }}</td>
                                    <td class="fw-semibold text-start" style="letter-spacing:0.5px;">{{ stu.full_name }}</td>
                                    <td>
                                        {% if stu.quiz_grade is not None %}
                                            <span class="badge {% if stu.quiz_grade >= 75 %}bg-success{% else %}bg-danger{% endif %} text-light">
                                                {{ stu.quiz_grade|floatformat:2 }}%
                                            </span>
                                        {% else %}
                                            <span class="badge text-dark">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if stu.exam_grade is not None %}
                                            <span class="badge {% if stu.exam_grade >= 75 %}bg-success{% else %}bg-danger{% endif %} text-light">
                                                {{ stu.exam_grade|floatformat:2 }}%
                                            </span>
                                        {% else %}
                                            <span class="badge text-dark">--</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold">
                                        {% if stu.grade is not None %}
                                            <span class="badge {% if stu.grade >= 75 %}bg-success{% else %}bg-danger{% endif %} text-light">
                                                {{ stu.grade|floatformat:2 }}%
                                            </span>
                                        {% else %}
                                            <span class="badge text-dark">--</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold">
                                        {% if stu.grade is not None %}
                                            {% if stu.grade >= 99 %}
                                                <span class="badge bg-success text-light">1.00</span>
                                            {% elif stu.grade >= 96 %}
                                                <span class="badge bg-success text-light">1.25</span>
                                            {% elif stu.grade >= 93 %}
                                                <span class="badge bg-success text-light">1.50</span>
                                            {% elif stu.grade >= 90 %}
                                                <span class="badge bg-success text-light">1.75</span>
                                            {% elif stu.grade >= 87 %}
                                                <span class="badge bg-success text-light">2.00</span>
                                            {% elif stu.grade >= 84 %}
                                                <span class="badge bg-success text-light">2.25</span>
                                            {% elif stu.grade >= 81 %}
                                                <span class="badge bg-success text-light">2.50</span>
                                            {% elif stu.grade >= 78 %}
                                                <span class="badge bg-success text-light">2.75</span>
                                            {% elif stu.grade >= 75 %}
                                                <span class="badge bg-success text-light">3.00</span>
                                            {% else %}
                                                <span class="badge bg-danger text-light">5.00</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge text-dark">--</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No grades data available for this selection.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== WRITTEN WORKS (20%) CARD ========== -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-maroon shadow-lg rounded-4 mb-5">
                <div class="card-header bg-white border-bottom-0 pb-0 rounded-top-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <i class="bi bi-journal-text fs-2 text-maroon"></i>
                            <h4 class="fw-bold m-0 text-maroon" style="font-size: 2rem;">
                                Written Works (20%)
                            </h4>
                        </div>
                        <p class="mb-0 text-muted small">Quiz results per student, per section, per grading period</p>
                    </div>
                    <div class="d-flex gap-2 mt-3 mt-md-0 flex-wrap">
                        <button id="downloadWWExcelBtn" class="btn btn-success btn-sm" type="button">
                            <i class="bi bi-file-earmark-excel"></i> Download as Excel
                        </button>
                        <button id="downloadWWDocBtn" class="btn btn-primary btn-sm" type="button">
                            <i class="bi bi-file-earmark-word"></i> Download as Docs
                        </button>
                    </div>
                </div>
                <div class="card-body pt-3 pb-4">
                    <form id="written-works-filter-form" class="row g-2 mb-3 align-items-end" method="get" autocomplete="off">
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Grading Period</label>
                            <select name="ww_grading_period" class="form-select">
                                {% for period in grading_periods %}
                                    <option value="{{ period.0 }}"{% if selected_ww_period|default:"prelim" == period.0 %} selected{% endif %}>{{ period.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Section</label>
                            <select name="ww_section" class="form-select">
                                {% for sec in section_choices %}
                                    <option value="{{ sec.0 }}"{% if sec.0 == selected_ww_section %} selected{% endif %}>{{ sec.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1 visually-hidden">Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search student name..." name="ww_search" value="{{ ww_search_query|default_if_none:'' }}">
                                <button class="btn btn-secondary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table id="written-works-table" class="table table-hover table-bordered align-middle rounded-4 shadow-sm overflow-hidden">

                                {% include 'dashboard/_written_works_table_body.html' %}
                        </table>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const form = document.getElementById('written-works-filter-form');
                            const tableContainer = document.getElementById('written-works-table');
                            
                            form.addEventListener('submit', function(e) {
                                e.preventDefault();
                                const formData = new FormData(form);
                                formData.append('ajax', '1');
                                formData.append('table', 'written_works');
                                
                                fetch(window.location.pathname + '?' + new URLSearchParams(formData), {
                                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                                })
                                .then(response => response.text())
                                .then(html => { 
                                    // Replace the entire table content
                                    tableContainer.innerHTML = html;
                                    // Reinitialize sorting functionality
                                    initSorting();
                                });
                            });
                            
                            form.querySelectorAll('select, input').forEach(el => {
                                el.addEventListener('change', function() {
                                    form.dispatchEvent(new Event('submit'));
                                });
                            });
                            
                            function initSorting() {
                                let currentSort = form.querySelector('input[name="sort"]') ? form.querySelector('input[name="sort"]').value : '';
                                let currentDir = form.querySelector('input[name="dir"]') ? form.querySelector('input[name="dir"]').value : 'asc';
                                document.querySelectorAll('#written-works-table th.sortable').forEach(function(th) {
                                    th.style.cursor = 'pointer';
                                    th.addEventListener('click', function() {
                                        const sortField = th.getAttribute('data-sort');
                                        let dir = 'asc';
                                        if (currentSort === sortField && currentDir === 'asc') dir = 'desc';
                                        let sortInput = form.querySelector('input[name="sort"]');
                                        let dirInput = form.querySelector('input[name="dir"]');
                                        if (!sortInput) {
                                            sortInput = document.createElement('input');
                                            sortInput.type = 'hidden';
                                            sortInput.name = 'sort';
                                            form.appendChild(sortInput);
                                        }
                                        if (!dirInput) {
                                            dirInput = document.createElement('input');
                                            dirInput.type = 'hidden';
                                            dirInput.name = 'dir';
                                            form.appendChild(dirInput);
                                        }
                                        sortInput.value = sortField;
                                        dirInput.value = dir;
                                        currentSort = sortField;
                                        currentDir = dir;
                                        form.dispatchEvent(new Event('submit'));
                                    });
                                });
                            }
                            // Initialize sorting on page load
                            initSorting();

                            // --- Download as Excel ---
                            document.getElementById('downloadWWExcelBtn').addEventListener('click', function() {
                                const periodSelect = form.querySelector('select[name="ww_grading_period"]');
                                const sectionSelect = form.querySelector('select[name="ww_section"]');
                                const searchInput = form.querySelector('input[name="ww_search"]');
                                const periodText = periodSelect.options[periodSelect.selectedIndex].text;
                                const sectionText = sectionSelect.options[sectionSelect.selectedIndex].text;
                                const searchText = searchInput ? searchInput.value : '';
                                const table = document.getElementById('written-works-table');
                                const headerCells = Array.from(table.querySelectorAll('thead th'));
                                const rows = Array.from(table.querySelectorAll('tbody tr'));
                                const headers = headerCells.map(th => th.innerText.trim());
                                const data = [
                                    ['Written Works Report', '', '', '', '', ''],
                                    ['Generated on', new Date().toLocaleDateString(), '', '', '', ''],
                                    ['', '', '', '', '', ''],
                                    ['Filter Information', '', '', '', '', ''],
                                    [`Grading Period: ${periodText}`, '', '', '', '', ''],
                                    [`Section: ${sectionText}`, '', '', '', '', ''],
                                    [`Search: ${searchText}`, '', '', '', '', ''],
                                    ['', '', '', '', '', ''],
                                    headers
                                ];
                                rows.forEach(row => {
                                    const cells = Array.from(row.querySelectorAll('td'));
                                    let rowData = [];
                                    cells.forEach((cell, i) => {
                                        const badge = cell.querySelector('.badge');
                                        rowData.push(badge ? badge.innerText.trim() : cell.innerText.trim());
                                    });
                                    data.push(rowData);
                                });
                                const ws = XLSX.utils.aoa_to_sheet(data);
                                ws['!cols'] = headers.map(() => ({ wch: 16 }));
                                const wb = XLSX.utils.book_new();
                                XLSX.utils.book_append_sheet(wb, ws, "Written Works");
                                XLSX.writeFile(wb, `Written_Works_${periodText}_${sectionText}_${new Date().toISOString().split('T')[0]}.xlsx`);
                            });

                            // --- Download as DOCX ---
                            document.getElementById('downloadWWDocBtn').addEventListener('click', function() {
                                if (!window.docx) {
                                    alert('Word export failed: The docx.js library is not loaded.');
                                    return;
                                }
                                const periodSelect = form.querySelector('select[name="ww_grading_period"]');
                                const sectionSelect = form.querySelector('select[name="ww_section"]');
                                const searchInput = form.querySelector('input[name="ww_search"]');
                                const periodText = periodSelect.options[periodSelect.selectedIndex].text;
                                const sectionText = sectionSelect.options[sectionSelect.selectedIndex].text;
                                const searchText = searchInput ? searchInput.value : '';
                                const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun, HeadingLevel, AlignmentType } = window.docx;
                                const table = document.getElementById('written-works-table');
                                const headerRow = table.querySelector('thead tr');
                                const rows = Array.from(table.querySelectorAll('tbody tr'));
                                function createHeaderCell(text) {
                                    return new TableCell({
                                        children: [new Paragraph({ children: [new TextRun({ text, bold: true })], alignment: AlignmentType.CENTER })]
                                    });
                                }
                                function createDataCell(text) {
                                    return new TableCell({
                                        children: [new Paragraph({ children: [new TextRun({ text })], alignment: AlignmentType.CENTER })]
                                    });
                                }
                                const headerCells = Array.from(headerRow.cells).map(cell => createHeaderCell(cell.innerText.trim()));
                                const dataRows = rows.map(row => {
                                    const cells = Array.from(row.querySelectorAll('td'));
                                    return new TableRow({
                                        children: cells.map(cell => {
                                            const badge = cell.querySelector('.badge');
                                            return createDataCell(badge ? badge.innerText.trim() : cell.innerText.trim());
                                        })
                                    });
                                });
                                const docTable = new Table({
                                    rows: [new TableRow({ children: headerCells }), ...dataRows]
                                });
                                const doc = new Document({
                                    sections: [{
                                        children: [
                                            new Paragraph({ text: "Written Works Report", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
                                            new Paragraph({ text: `Generated on ${new Date().toLocaleDateString()}`, alignment: AlignmentType.CENTER }),
                                            new Paragraph({ text: "Filter Information", heading: HeadingLevel.HEADING_3 }),
                                            new Paragraph({ text: `Grading Period: ${periodText}` }),
                                            new Paragraph({ text: `Section: ${sectionText}` }),
                                            new Paragraph({ text: `Search: ${searchText}` }),
                                            docTable
                                        ]
                                    }]
                                });
                                Packer.toBlob(doc).then(blob => {
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `Written_Works_${periodText}_${sectionText}_${new Date().toISOString().split('T')[0]}.docx`;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                });
                            });
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== PERFORMANCE TASK (50%) CARD ========== -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-maroon shadow-lg rounded-4 mb-5">
                <div class="card-header bg-white border-bottom-0 pb-0 rounded-top-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <i class="bi bi-clipboard-check fs-2 text-maroon"></i>
                            <h4 class="fw-bold m-0 text-maroon" style="font-size: 2rem;">
                                Performance Task (50%)
                            </h4>
                        </div>
                        <p class="mb-0 text-muted small">Performance task, attendance, and scores per student, per section, per grading period</p>
                    </div>
                    <div class="d-flex gap-2 mt-3 mt-md-0 flex-wrap">
                        <button id="downloadPTExcelBtn" class="btn btn-success btn-sm" type="button">
                            <i class="bi bi-file-earmark-excel"></i> Download as Excel
                        </button>
                        <button id="downloadPTDocBtn" class="btn btn-primary btn-sm" type="button">
                            <i class="bi bi-file-earmark-word"></i> Download as Docs
                        </button>
                    </div>
                </div>
                <div class="card-body pt-3 pb-4">
                    <form id="performance-task-filter-form" class="row g-2 mb-3 align-items-end" method="get" autocomplete="off">
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Grading Period</label>
                            <select name="pt_grading_period" class="form-select">
                                {% for period in grading_periods %}
                                    <option value="{{ period.0 }}"{% if period.0 == selected_pt_period %} selected{% endif %}>{{ period.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Section</label>
                            <select name="pt_section" class="form-select">
                                {% for sec in section_choices %}
                                    <option value="{{ sec.0 }}"{% if sec.0 == selected_pt_section %} selected{% endif %}>{{ sec.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1 visually-hidden">Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search student name..." name="pt_search" value="{{ pt_search_query|default_if_none:'' }}">
                                <button class="btn btn-secondary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const form = document.getElementById('performance-task-filter-form');
                        const tableBody = document.querySelector('#performance-task-table tbody');
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            const formData = new FormData(form);
                            formData.append('ajax', '1');
                            formData.append('table', 'performance_task');
                            fetch(window.location.pathname + '?' + new URLSearchParams(formData), {
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            })
                            .then(response => response.text())
                            .then(html => { tableBody.innerHTML = html; });
                        });
                        form.querySelectorAll('select, input').forEach(el => {
                            el.addEventListener('change', function() {
                                form.dispatchEvent(new Event('submit'));
                            });
                        });
                        // Sorting (if needed in the future)
                        // let currentSort = form.querySelector('input[name="sort"]') ? form.querySelector('input[name="sort"]').value : '';
                        // let currentDir = form.querySelector('input[name="dir"]') ? form.querySelector('input[name="dir"]').value : 'asc';
                        // document.querySelectorAll('#performance-task-table th.sortable').forEach(function(th) {
                        //     th.style.cursor = 'pointer';
                        //     th.addEventListener('click', function() {
                        //         const sortField = th.getAttribute('data-sort');
                        //         let dir = 'asc';
                        //         if (currentSort === sortField && currentDir === 'asc') dir = 'desc';
                        //         let sortInput = form.querySelector('input[name="sort"]');
                        //         let dirInput = form.querySelector('input[name="dir"]');
                        //         if (!sortInput) {
                        //             sortInput = document.createElement('input');
                        //             sortInput.type = 'hidden';
                        //             sortInput.name = 'sort';
                        //             form.appendChild(sortInput);
                        //         }
                        //         if (!dirInput) {
                        //             dirInput = document.createElement('input');
                        //             dirInput.type = 'hidden';
                        //             dirInput.name = 'dir';
                        //             form.appendChild(dirInput);
                        //         }
                        //         sortInput.value = sortField;
                        //         dirInput.value = dir;
                        //         currentSort = sortField;
                        //         currentDir = dir;
                        //         form.dispatchEvent(new Event('submit'));
                        //     });
                        // });
                    });
                    </script>
                    <div class="table-responsive">
                        <table id="performance-task-table" class="table table-hover table-bordered align-middle rounded-4 shadow-sm overflow-hidden">
                            <thead class="text-center rounded-top-4">
                                <tr class="fw-semibold text-maroon bg-light">
                                    <th class="bg-white rounded-start-3 sortable" data-sort="section">Section</th>
                                    <th class="bg-white sortable" data-sort="full_name">Name</th>
                                    <th class="bg-white sortable" data-sort="attendance">
                                        Attendance
                                        <button class="btn btn-link btn-sm p-0 ms-1" data-bs-toggle="modal" data-bs-target="#editTotalDaysModal" title="Edit total days for all">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                    </th>
                                    <th class="bg-white sortable" data-sort="percent_score">Percentage Score</th>
                                    <th class="bg-white sortable" data-sort="weighted_score">Weighted Score</th>
                                    <th class="bg-white rounded-end-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if performance_tasks %}
                                {% for pt in performance_tasks %}
                                <tr class="text-center align-middle">
                                    <td class="fw-medium">{{ pt.section }}</td>
                                    <td class="fw-semibold text-start" style="letter-spacing:0.5px;">{{ pt.full_name }}</td>
                                    <td>
                                        {% if pt.days_present is not None and pt.total_days is not None %}
                                            <span class="badge text-dark">
                                                {{ pt.days_present }}/{{ pt.total_days }} ({{ pt.attendance_percent|floatformat:2 }}%)
                                            </span>

                                        {% elif pt.attendance is not None %}
                                            <span class="badge text-dark">{{ pt.attendance }}</span>
                                        {% else %}
                                            <span class="badge text-dark">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if pt.percent_score is not None %}
                                            <span class="badge text-dark">{{ pt.percent_score|floatformat:2 }}%</span>
                                        {% else %}
                                            <span class="badge text-dark">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if pt.weighted_score is not None %}
                                            <span class="badge text-dark">{{ pt.weighted_score|floatformat:2 }}%</span>
                                        {% else %}
                                            <span class="badge text-dark">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No performance task data available for this selection.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== EXAM GRADES CARD ========== -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-maroon shadow-lg rounded-4 mb-5">
                <div class="card-header bg-white border-bottom-0 pb-0 rounded-top-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <i class="bi bi-clipboard-data fs-2 text-maroon"></i>
                            <h4 class="fw-bold m-0 text-maroon" style="font-size: 2rem;">
                                Examinations(30%)
                            </h4>
                        </div>
                        <p class="mb-0 text-muted small">Exam results per student, per section, per grading period</p>
                    </div>
                    <div class="d-flex gap-2 mt-3 mt-md-0 flex-wrap">
                        <button id="downloadExamExcelBtn" class="btn btn-success btn-sm" type="button">
                            <i class="bi bi-file-earmark-excel"></i> Download as Excel
                        </button>
                        <button id="downloadExamDocBtn" class="btn btn-primary btn-sm" type="button">
                            <i class="bi bi-file-earmark-word"></i> Download as Docs
                        </button>
                    </div>
                </div>
                <div class="card-body pt-3 pb-4">
                    <form id="exam-grades-filter-form" class="row g-2 mb-3 align-items-end" method="get" autocomplete="off">
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Grading Period</label>
                            <select name="exam_grading_period" class="form-select">
                                {% for period in grading_periods %}
                                    <option value="{{ period.0 }}"{% if period.0 == selected_exam_period %} selected{% endif %}>{{ period.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1">Section</label>
                            <select name="exam_section" class="form-select">
                                {% for sec in section_choices %}
                                    <option value="{{ sec.0 }}"{% if sec.0 == selected_exam_section %} selected{% endif %}>{{ sec.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label fw-semibold mb-1 visually-hidden">Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search student name..." name="exam_search" value="{{ exam_search_query|default_if_none:'' }}">
                                <button class="btn btn-secondary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const form = document.getElementById('exam-grades-filter-form');
                        const tableBody = document.querySelector('#exam-grades-table tbody');
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            const formData = new FormData(form);
                            formData.append('ajax', '1');
                            formData.append('table', 'exam_grades');
                            fetch(window.location.pathname + '?' + new URLSearchParams(formData), {
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            })
                            .then(response => response.text())
                            .then(html => { tableBody.innerHTML = html; });
                        });
                        form.querySelectorAll('select, input').forEach(el => {
                            el.addEventListener('change', function() {
                                form.dispatchEvent(new Event('submit'));
                            });
                        });
                        // Sorting
                        let currentSort = form.querySelector('input[name="sort"]') ? form.querySelector('input[name="sort"]').value : '';
                        let currentDir = form.querySelector('input[name="dir"]') ? form.querySelector('input[name="dir"]').value : 'asc';
                        document.querySelectorAll('#exam-grades-table th.sortable').forEach(function(th) {
                            th.style.cursor = 'pointer';
                            th.addEventListener('click', function() {
                                const sortField = th.getAttribute('data-sort');
                                let dir = 'asc';
                                if (currentSort === sortField && currentDir === 'asc') dir = 'desc';
                                let sortInput = form.querySelector('input[name="sort"]');
                                let dirInput = form.querySelector('input[name="dir"]');
                                if (!sortInput) {
                                    sortInput = document.createElement('input');
                                    sortInput.type = 'hidden';
                                    sortInput.name = 'sort';
                                    form.appendChild(sortInput);
                                }
                                if (!dirInput) {
                                    dirInput = document.createElement('input');
                                    dirInput.type = 'hidden';
                                    dirInput.name = 'dir';
                                    form.appendChild(dirInput);
                                }
                                sortInput.value = sortField;
                                dirInput.value = dir;
                                currentSort = sortField;
                                currentDir = dir;
                                form.dispatchEvent(new Event('submit'));
                            });
                        });
                    });
                    </script>
                    <div class="table-responsive">
                        <table id="exam-grades-table" class="table table-hover table-bordered align-middle rounded-4 shadow-sm overflow-hidden">
                            <thead class="text-center rounded-top-4">
                                <tr class="fw-semibold text-maroon bg-light">
                                    <th class="bg-white rounded-start-3 sortable" data-sort="section">Section <span class="sort-arrows">{% if exam_sort == 'section' %}{% if exam_dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="bg-white sortable" data-sort="full_name">Name <span class="sort-arrows">{% if exam_sort == 'full_name' %}{% if exam_dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="sortable" data-sort="score_display">Score <span class="sort-arrows">{% if exam_sort == 'score_display' %}{% if exam_dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="sortable" data-sort="percent_score">Percentage Score <span class="sort-arrows">{% if exam_sort == 'percent_score' %}{% if exam_dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                    <th class="sortable" data-sort="weighted_score">Weighted Score <span class="sort-arrows">{% if exam_sort == 'weighted_score' %}{% if exam_dir == 'asc' %}{% else %}{% endif %}{% else %}{% endif %}</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if exam_grades %}
                                {% for exam in exam_grades %}
                                <tr class="text-center align-middle">
                                <td class="fw-medium">{{ exam.section }}</td>
                                <td class="fw-semibold text-start" style="letter-spacing:0.5px;">{{ exam.full_name }}</td>
                                <td>
                                <span class="badge text-dark">{{ exam.score_display }}</span>
                                </td>
                                <td>
                                {% if exam.percent_score is not None %}
                                <span class="badge text-dark">{{ exam.percent_score|floatformat:2 }}%</span>
                                {% else %}
                                <span class="badge text-dark">--</span>
                                {% endif %}
                                </td>
                                <td>
                                {% if exam.weighted_score is not None %}
                                <span class="badge text-dark">{{ exam.weighted_score|floatformat:2 }}%</span>
                                {% else %}
                                <span class="badge text-dark">--</span>
                                {% endif %}
                                </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                <td colspan="6" class="text-center text-muted">No exam grades data available for this selection.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Total Days Modal (Header) -->
    <div class="modal fade" id="editTotalDaysModal" tabindex="-1" aria-labelledby="editTotalDaysLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <form method="post" action="{% url 'edit_total_days' %}">
            {% csrf_token %}
            <div class="modal-header">
            <h5 class="modal-title" id="editTotalDaysLabel">Edit Total Days for All Students</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <input type="hidden" name="grading_period" id="modalGradingPeriodInput" value="{{ selected_pt_period }}">
            <div class="mb-3">
                <label for="totalDaysInputAll" class="form-label">Total Days</label>
                <input type="number" class="form-control" id="totalDaysInputAll" name="total_days" min="0" required>
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
        </div>
    </div>
    </div>
</div>
<script>
// Ensure the grading period in the modal matches the current filter when opened
const editTotalDaysModal = document.getElementById('editTotalDaysModal');
if (editTotalDaysModal) {
    editTotalDaysModal.addEventListener('show.bs.modal', function (event) {
        const gradingPeriodSelect = document.querySelector('#performance-task-filter-form select[name="pt_grading_period"]');
        const modalGradingPeriodInput = document.getElementById('modalGradingPeriodInput');
        if (gradingPeriodSelect && modalGradingPeriodInput) {
            modalGradingPeriodInput.value = gradingPeriodSelect.value;
        }
    });
}

// AJAX submit for Edit Total Days form
const editTotalDaysForm = editTotalDaysModal ? editTotalDaysModal.querySelector('form') : null;
if (editTotalDaysForm) {
    editTotalDaysForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(editTotalDaysForm);
        fetch(editTotalDaysForm.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            // Close modal
            const modalInstance = bootstrap.Modal.getInstance(editTotalDaysModal);
            if (modalInstance) modalInstance.hide();
            // Refresh performance task table
            const ptForm = document.getElementById('performance-task-filter-form');
            if (ptForm) ptForm.dispatchEvent(new Event('submit'));
            // Optionally show a toast or alert
            if (data && data.message) {
                alert(data.message);
            }
        })
        .catch(err => {
            alert('Failed to update total days.');
        });
    });
}
</script>

<style>
.text-maroon { color: #6A1829 !important; }
.border-maroon { border-color: #6A1829 !important; }
.text-black { color: #191919 !important; }

.ranking-row {
  background: #fff !important;
  color: #191919 !important;
}
.ranking-row-1 {
  background: #6A1829 !important;
  color: #fff !important;
}
.ranking-row-1 td,
.ranking-row-1 th,
.ranking-row-1 span,
.ranking-row-1 .fw-bold,
.ranking-row-1 .fw-semibold {
  color: #fff !important;
}
.ranking-row-1 svg, .ranking-row-1 i {
  color: #fff !important;
}
.ranking-row td, .ranking-row th, .ranking-row span, .ranking-row .fw-bold, .ranking-row .fw-semibold {
  color: #191919 !important;
}
.ranking-row svg, .ranking-row i {
  color: #6A1829 !important;
}

/* Grade badge styles */
.card .badge { font-size: 1.01em; }
.badge.bg-success { background: #d1fae5; color: var(--success-color); }
.badge.bg-warning { background: #fff3cd; color: #ae8000; }
.badge.bg-danger  { background: #fde5e5; color: #c53b3b; }

.grading-period-card {
    border-radius: 14px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08), 0 1.5px 5px rgba(86,113,156,.02);
    overflow: hidden;
    position: relative;
    transition: box-shadow 0.18s;
}
.grading-period-card:hover {
    box-shadow: 0 6px 30px rgba(0,0,0,0.10);
}
.display-5 { font-size: 2.8rem; }
.period-status i {
    font-size: 1.45em;
}
.theme-shadow { box-shadow: 0 2px 10px rgba(0,0,0,0.08), 0 1.5px 5px rgba(86,113,156,.02) !important; }
.theme-muted { color: #888 !important; }
.bg-light { background-color: #f8f9fa !important; }
.bg-primary, .btn-theme-primary { background: var(--primary-color) !important; color: #fff !important; }
.bg-warning { background: #fff3cd !important; }
.theme-success { color: var(--success-color) !important; }
.theme-danger { color: var(--danger-color) !important; }
.badge { font-weight: 600; border-radius: 8px; }
.btn-theme-primary {
    font-size: 1.13rem; font-weight: 600; border-radius: 10px; background: var(--primary-color); color: #fff;
    border: none; transition: background 0.15s;
    padding: 0.75rem 1.1rem;
}
.btn-theme-primary:hover, .btn-theme-primary:focus {
    background: var(--secondary-color) !important;
    color: #fff !important;
}

/* New maroon outline button */
.btn-theme-maroon-outline {
    font-size: 1.13rem;
    font-weight: 600;
    border-radius: 10px;
    background: #fff;
    color: #6A1829;
    border: 2px solid #6A1829;
    transition: background 0.15s, color 0.15s;
    padding: 0.75rem 1.1rem;
}
.btn-theme-maroon-outline:hover,
.btn-theme-maroon-outline:focus {
    background: #6A1829;
    color: #fff;
}
/* Soft card for modal content */
.theme-card-soft {
    border-radius: 1rem;
    background: #fff !important;
    box-shadow: 0 2px 12px rgba(86,113,156,0.05);
}
.theme-modal-soft .modal-content {
    border-radius: 1rem !important;
    box-shadow: 0 8px 32px rgba(86,113,156,0.10) !important;
}
.theme-modal-soft .modal-header {
    border-bottom: none !important;
}
.theme-modal-soft .modal-body {
    background: #f8f9fa;
}
.theme-modal-soft .form-label,
.theme-modal-soft .modal-title {
    font-size: 1.25rem !important;
    font-weight: 600 !important;
}
.theme-modal-soft .modal-title.badge {
    font-size: 1.08rem !important;
    font-weight: 500 !important;
}
@media (max-width: 767px) {
    .grading-period-card .card-body { padding: 2rem 1rem !important; }
    .badge { font-size: 1.03rem !important; padding: 0.62em 0.98em !important; }
    .btn-theme-primary,
    .btn-theme-maroon-outline { font-size: 1.03rem !important; padding: 0.68rem 0.85rem !important; }
    .theme-card-soft { padding: 1.3rem !important; }
    .theme-modal-soft .modal-header { padding-left: 1.3rem !important; padding-right: 1.3rem !important; }
}
</style>


<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to get filter info
    function getFilterInfo() {
        const form = document.getElementById('students-grades-filter-form');
        const periodSelect = form.querySelector('select[name="grading_period"]');
        const sectionSelect = form.querySelector('select[name="section"]');
        
        // Get selected text (not just value)
        const periodText = periodSelect.options[periodSelect.selectedIndex].text;
        const sectionText = sectionSelect.options[sectionSelect.selectedIndex].text;
        
        return {
            period: periodText,
            section: sectionText
        };
    }

    // --- Excel Export with Filter Info ---
    document.getElementById('downloadExcelBtn').addEventListener('click', function() {
        const filterInfo = getFilterInfo();
        const table = document.getElementById('students-grades-table');
        const headerCells = Array.from(table.querySelectorAll('thead th'));
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        // App color references
        const MAROON = '6A1829';
        const MAROON_FG = 'FFFFFF';
        const APP_BG = 'FAFBFF';
        const LIGHT_BG = 'F6F8FC';
        const BORDER = 'e4e9f2';
        const PASS_BG = 'DFF0D8';
        const PASS_TEXT = '388E3C';
        const FAIL_BG = 'F8D7DA';
        const FAIL_TEXT = 'C62828';
        const FONT = 'Poppins,Segoe UI,Tahoma,Geneva,Verdana,sans-serif';

        // Build data array with filter info as first rows
        const headers = headerCells.map(th => th.innerText.trim());
        const data = [
            ['Students Grades Report', '', '', '', '', ''],
            ['Generated on', new Date().toLocaleDateString(), '', '', '', ''],
            ['', '', '', '', '', ''],
            ['Filter Information', '', '', '', '', ''],
            [`Grading Period: ${filterInfo.period}`, '', '', '', '', ''],
            [`Section: ${filterInfo.section}`, '', '', '', '', ''],
            ['', '', '', '', '', ''],
            headers // Actual table headers
        ];
        
        // Add student data
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            let rowData = [];
            
            cells.forEach((cell, i) => {
                if (i === 5) {
                    const badge = cell.querySelector('.badge');
                    rowData.push(badge ? badge.innerText.trim() : '--');
                } 
                else if (i >= 2 && i <= 4) {
                    const badge = cell.querySelector('.badge');
                    if (badge && !badge.innerText.includes('--')) {
                        rowData.push(parseFloat(badge.innerText.replace('%','').trim()));
                    } else {
                        rowData.push('--');
                    }
                }
                else {
                    rowData.push(cell.innerText.trim());
                }
            });
            data.push(rowData);
        });

        // Sheet setup
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Column widths
        ws['!cols'] = [
            { wch: 12 }, // Section
            { wch: 25 }, // Name
            { wch: 14 }, // Quiz Grade
            { wch: 14 }, // Exam Grade
            { wch: 14 }, // Final Grade
            { wch: 10 }  // GPA
        ];

        // Common fonts
        function appFont(sz, bold, color) {
            return {
                name: 'Poppins',
                sz: sz,
                color: { rgb: color || MAROON },
                bold: !!bold
            };
        }

        // Header row style
        const headerStyle = {
            font: { name: 'Poppins', sz:12, bold: true, color:{rgb: MAROON_FG} },
            fill: { fgColor: { rgb: MAROON } },
            alignment: { vertical: 'center', horizontal: 'center' },
            border: {
                top:    { style: "thin", color:{rgb:BORDER} },
                bottom: { style: "thin", color:{rgb:BORDER} },
                left:   { style: "thin", color:{rgb:BORDER} },
                right:  { style: "thin", color:{rgb:BORDER} },
            }
        };

        // Main cell style
        const baseStyle = {
            font: { name: 'Poppins', sz:11 },
            fill: { fgColor: { rgb: APP_BG } },
            alignment: { vertical:"center", horizontal: "center", wrapText:true },
            border: headerStyle.border
        };

        // Report header style
        const reportHeaderStyle = {
            font: { name: 'Poppins', sz:16, bold: true, color:{rgb: MAROON} },
            alignment: { horizontal: "center" }
        };

        // Filter info style
        const filterStyle = {
            font: { name: 'Poppins', sz:12, bold: true },
            alignment: { horizontal: "left" }
        };

        // Apply styles to all cells
        for (let r = 0; r < data.length; ++r) {
            for (let c = 0; c < data[r].length; ++c) {
                const addr = XLSX.utils.encode_cell({c, r});
                if (!ws[addr]) continue;
                
                // Report header rows
                if (r === 0) {
                    ws[addr].s = reportHeaderStyle;
                    continue;
                }
                
                // Filter info rows
                if (r >= 3 && r <= 5) {
                    ws[addr].s = filterStyle;
                    continue;
                }
                
                // Actual table header (row 7)
                if (r === 7) {
                    ws[addr].s = headerStyle;
                    continue;
                }
                
                // Data rows (starting from row 8)
                if (r >= 8) {
                    let style = (r % 2 === 0) ? baseStyle : {...baseStyle, fill: { fgColor: { rgb: LIGHT_BG } }};
                    
                    // Apply grade coloring for grade columns (2-4)
                    if (c >= 2 && c <= 4 && data[r][c] !== '--') {
                        const grade = parseFloat(data[r][c]);
                        if (!isNaN(grade)) {
                            style = grade >= 75 ? 
                                { ...baseStyle, fill: { fgColor: { rgb: PASS_BG } }, font: { ...baseStyle.font, color: {rgb: PASS_TEXT}, bold: true } } : 
                                { ...baseStyle, fill: { fgColor: { rgb: FAIL_BG } }, font: { ...baseStyle.font, color: {rgb: FAIL_TEXT}, bold: true } };
                            ws[addr].s = style;
                            continue;
                        }
                    }
                    
                    // Apply GPA coloring (column 5)
                    if (c === 5 && data[r][c] !== '--') {
                        const gpa = parseFloat(data[r][c]);
                        if (!isNaN(gpa)) {
                            style = gpa <= 3.00 ? 
                                { ...baseStyle, fill: { fgColor: { rgb: PASS_BG } }, font: { ...baseStyle.font, color: {rgb: PASS_TEXT}, bold: true } } : 
                                { ...baseStyle, fill: { fgColor: { rgb: FAIL_BG } }, font: { ...baseStyle.font, color: {rgb: FAIL_TEXT}, bold: true } };
                            ws[addr].s = style;
                            continue;
                        }
                    }
                    
                    // Default style
                    ws[addr].s = style;
                }
            }
        }

        // Merge cells for report header and filter info
        ws['!merges'] = [
            // Report title
            { s: {r:0, c:0}, e: {r:0, c:5} },
            // Generated date
            { s: {r:1, c:0}, e: {r:1, c:1} },
            // Filter information header
            { s: {r:3, c:0}, e: {r:3, c:5} }
        ];

        // Workbook and save
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Grades");
        XLSX.writeFile(wb, `Students_Grades_${filterInfo.period}_${filterInfo.section}_${new Date().toISOString().split('T')[0]}.xlsx`);
    });

    // --- Word Export (DOCX) with Filter Info ---
    document.getElementById('downloadDocBtn').addEventListener('click', function() {
        if (!window.docx) {
            alert('Word export failed: The docx.js library is not loaded. Please check your network or try again in a few seconds.');
            return;
        }
        const filterInfo = getFilterInfo();
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun, HeadingLevel, AlignmentType, ShadingType, BorderStyle } = window.docx;

        // App color references
        const MAROON = '6A1829';
        const MAROON_TEXT = '6A1829';
        const HEADER_BG = MAROON;
        const HEADER_TEXT = 'FFFFFF';
        const BORDER_COLOR = 'E4E9F2';
        const APP_BG = 'FAFBFF';
        const LIGHT_BG = 'F6F8FC';
        const PASS_BG = 'DFF0D8';
        const PASS_TEXT = '388E3C';
        const FAIL_BG = 'F8D7DA';
        const FAIL_TEXT = 'C62828';
        const APP_FONT = 'Poppins';
        const TABLE_MARGIN = { top: 100, bottom: 100 };

        const table = document.getElementById('students-grades-table');
        const headerRow = table.querySelector('thead tr');
        const rows = Array.from(table.querySelectorAll('tbody tr'));

        // Header cell creator
        function createHeaderCell(text) {
            return new TableCell({
                children: [new Paragraph({
                    children: [
                        new TextRun({
                            text,
                            bold: true,
                            color: HEADER_TEXT,
                            font: APP_FONT
                        })
                    ],
                    alignment: AlignmentType.CENTER,
                })],
                shading: {
                    type: ShadingType.CLEAR,
                    fill: HEADER_BG
                },
                margins: { top: 140, bottom: 140, left: 140, right: 140 },
                borders: {
                    top:    { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 6 },
                    bottom: { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 6 },
                    left:   { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 6 },
                    right:  { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 6 },
                }
            });
        }

        // Data cell creator
        function createDataCell(text, rowIdx, colIdx) {
            // Zebra background
            let bg = (rowIdx % 2 === 1) ? LIGHT_BG : APP_BG;
            let fontColor = MAROON_TEXT, bold = false;
            let shades = undefined;

            // Grade columns (2-4) and GPA column (5)
            if ((colIdx >= 2 && colIdx <= 5) && text !== '--') {
                const numericValue = parseFloat(text);
                if (!isNaN(numericValue)) {
                    bold = true;
                    // For GPA (col 5)
                    if (colIdx === 5) {
                        if (numericValue <= 3.00) {
                            fontColor = PASS_TEXT;
                            shades = { type: ShadingType.CLEAR, fill: PASS_BG };
                        } else {
                            fontColor = FAIL_TEXT;
                            shades = { type: ShadingType.CLEAR, fill: FAIL_BG };
                        }
                    } 
                    // For grade columns (2-4)
                    else if (numericValue >= 75) {
                        fontColor = PASS_TEXT;
                        shades = { type: ShadingType.CLEAR, fill: PASS_BG };
                    } else {
                        fontColor = FAIL_TEXT;
                        shades = { type: ShadingType.CLEAR, fill: FAIL_BG };
                    }
                }
            }
            
            return new TableCell({
                children: [
                    new Paragraph({
                        children: [new TextRun({
                            text,
                            bold,
                            color: fontColor,
                            font: APP_FONT
                        })],
                        alignment: AlignmentType.CENTER,
                    })
                ],
                shading: shades || { type: ShadingType.CLEAR, fill: bg },
                margins: { top: 140, bottom: 140, left: 140, right: 140 },
                borders: {
                    top:    { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 4 },
                    bottom: { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 4 },
                    left:   { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 4 },
                    right:  { style: BorderStyle.SINGLE, color: BORDER_COLOR, size: 4 },
                }
            });
        }

        // Build header cells
        const headerCells = Array.from(headerRow.cells).map(cell => 
            createHeaderCell(cell.innerText.trim())
        );

        // Build data rows
        const dataRows = rows.map((row, ridx) => {
            const cells = Array.from(row.querySelectorAll('td'));
            return new TableRow({
                children: cells.map((cell, cidx) => {
                    let cellText;
                    // For GPA column, get the badge text
                    if (cidx === 5) {
                        const badge = cell.querySelector('.badge');
                        cellText = badge ? badge.innerText.trim() : '--';
                    } 
                    // For grade columns, get the percentage value
                    else if (cidx >= 2 && cidx <= 4) {
                        const badge = cell.querySelector('.badge');
                        cellText = (badge && !badge.innerText.includes('--')) ? 
                            badge.innerText.replace('%','').trim() : '--';
                    }
                    // For regular columns
                    else {
                        cellText = cell.innerText.trim();
                    }
                    return createDataCell(cellText, ridx, cidx);
                })
            });
        });

        // Create document
        const docTable = new Table({
            rows: [new TableRow({ children: headerCells }), ...dataRows],
            width: { size: 100, type: 'pct' },
            margins: TABLE_MARGIN,
            alignment: AlignmentType.CENTER,
        });

        const doc = new Document({
            sections: [{
                children: [
                    new Paragraph({
                        text: "Students Grades Report",
                        heading: HeadingLevel.HEADING_1,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 }
                    }),
                    new Paragraph({ 
                        text: `Generated on ${new Date().toLocaleDateString()}`,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 }
                    }),
                    new Paragraph({
                        text: "Filter Information",
                        heading: HeadingLevel.HEADING_3,
                        spacing: { after: 100 }
                    }),
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: `Grading Period: ${filterInfo.period}`,
                                bold: true
                            })
                        ],
                        spacing: { after: 50 }
                    }),
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: `Section: ${filterInfo.section}`,
                                bold: true
                            })
                        ],
                        spacing: { after: 200 }
                    }),
                    docTable
                ]
            }]
        });

        // Download the document
        Packer.toBlob(doc).then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Students_Grades_${filterInfo.period}_${filterInfo.section}_${new Date().toISOString().split('T')[0]}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
});

// Exam Grades Card Export Logic
document.addEventListener('DOMContentLoaded', function() {
    function getExamFilterInfo() {
        const form = document.getElementById('exam-grades-filter-form');
        const periodSelect = form.querySelector('select[name="exam_grading_period"]');
        const sectionSelect = form.querySelector('select[name="exam_section"]');
        const periodText = periodSelect.options[periodSelect.selectedIndex].text;
        const sectionText = sectionSelect.options[sectionSelect.selectedIndex].text;
        return { period: periodText, section: sectionText };
    }

    // Excel Export
    document.getElementById('downloadExamExcelBtn').addEventListener('click', function() {
        const filterInfo = getExamFilterInfo();
        const table = document.getElementById('exam-grades-table');
        const headerCells = Array.from(table.querySelectorAll('thead th'));
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const headers = headerCells.map(th => th.innerText.trim());
        const data = [
            ['Exam Grades Report', '', '', '', ''],
            ['Generated on', new Date().toLocaleDateString(), '', '', ''],
            ['', '', '', '', ''],
            ['Filter Information', '', '', '', ''],
            [`Grading Period: ${filterInfo.period}`, '', '', '', ''],
            [`Section: ${filterInfo.section}`, '', '', '', ''],
            ['', '', '', '', ''],
            headers
        ];
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            let rowData = [];
            cells.forEach((cell, i) => {
                const badge = cell.querySelector('.badge');
                rowData.push(badge ? badge.innerText.trim() : cell.innerText.trim());
            });
            data.push(rowData);
        });
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = [
            { wch: 12 }, { wch: 25 }, { wch: 14 }, { wch: 14 }, { wch: 12 }
        ];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Exam Grades");
        XLSX.writeFile(wb, `Exam_Grades_${filterInfo.period}_${filterInfo.section}_${new Date().toISOString().split('T')[0]}.xlsx`);
    });

    // Word Export
    document.getElementById('downloadExamDocBtn').addEventListener('click', function() {
        if (!window.docx) {
            alert('Word export failed: The docx.js library is not loaded.');
            return;
        }
        const filterInfo = getExamFilterInfo();
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun, HeadingLevel, AlignmentType } = window.docx;
        const table = document.getElementById('exam-grades-table');
        const headerRow = table.querySelector('thead tr');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        function createHeaderCell(text) {
            return new TableCell({
                children: [new Paragraph({ children: [new TextRun({ text, bold: true })], alignment: AlignmentType.CENTER })]
            });
        }
        function createDataCell(text) {
            return new TableCell({
                children: [new Paragraph({ children: [new TextRun({ text })], alignment: AlignmentType.CENTER })]
            });
        }
        const headerCells = Array.from(headerRow.cells).map(cell => createHeaderCell(cell.innerText.trim()));
        const dataRows = rows.map(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            return new TableRow({
                children: cells.map(cell => {
                    const badge = cell.querySelector('.badge');
                    return createDataCell(badge ? badge.innerText.trim() : cell.innerText.trim());
                })
            });
        });
        const docTable = new Table({
            rows: [new TableRow({ children: headerCells }), ...dataRows]
        });
        const doc = new Document({
            sections: [{
                children: [
                    new Paragraph({ text: "Exam Grades Report", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: `Generated on ${new Date().toLocaleDateString()}`, alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: "Filter Information", heading: HeadingLevel.HEADING_3 }),
                    new Paragraph({ text: `Grading Period: ${filterInfo.period}` }),
                    new Paragraph({ text: `Section: ${filterInfo.section}` }),
                    docTable
                ]
            }]
        });
        Packer.toBlob(doc).then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Exam_Grades_${filterInfo.period}_${filterInfo.section}_${new Date().toISOString().split('T')[0]}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
});
</script>

<!-- Performance Task Export Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Excel Export
    document.getElementById('downloadPTExcelBtn').addEventListener('click', function() {
        const form = document.getElementById('performance-task-filter-form');
        const periodSelect = form.querySelector('select[name="pt_grading_period"]');
        const sectionSelect = form.querySelector('select[name="pt_section"]');
        const searchInput = form.querySelector('input[name="pt_search"]');
        const periodText = periodSelect.options[periodSelect.selectedIndex].text;
        const sectionText = sectionSelect.options[sectionSelect.selectedIndex].text;
        const searchText = searchInput ? searchInput.value : '';
        const table = document.getElementById('performance-task-table');
        const headerCells = Array.from(table.querySelectorAll('thead th'));
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const headers = headerCells.map(th => th.innerText.trim());
        const data = [
            ['Performance Task Report', '', '', '', '', ''],
            ['Generated on', new Date().toLocaleDateString(), '', '', '', ''],
            ['', '', '', '', '', ''],
            ['Filter Information', '', '', '', '', ''],
            [`Grading Period: ${periodText}`, '', '', '', '', ''],
            [`Section: ${sectionText}`, '', '', '', '', ''],
            [`Search: ${searchText}`, '', '', '', '', ''],
            ['', '', '', '', '', ''],
            headers
        ];
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            let rowData = [];
            cells.forEach((cell, i) => {
                const badge = cell.querySelector('.badge');
                rowData.push(badge ? badge.innerText.trim() : cell.innerText.trim());
            });
            data.push(rowData);
        });
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = headers.map(() => ({ wch: 16 }));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Performance Task");
        XLSX.writeFile(wb, `Performance_Task_${periodText}_${sectionText}_${new Date().toISOString().split('T')[0]}.xlsx`);
    });

    // Word Export
    document.getElementById('downloadPTDocBtn').addEventListener('click', function() {
        if (!window.docx) {
            alert('Word export failed: The docx.js library is not loaded.');
            return;
        }
        const form = document.getElementById('performance-task-filter-form');
        const periodSelect = form.querySelector('select[name="pt_grading_period"]');
        const sectionSelect = form.querySelector('select[name="pt_section"]');
        const searchInput = form.querySelector('input[name="pt_search"]');
        const periodText = periodSelect.options[periodSelect.selectedIndex].text;
        const sectionText = sectionSelect.options[sectionSelect.selectedIndex].text;
        const searchText = searchInput ? searchInput.value : '';
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun, HeadingLevel, AlignmentType } = window.docx;
        const table = document.getElementById('performance-task-table');
        const headerRow = table.querySelector('thead tr');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        function createHeaderCell(text) {
            return new TableCell({
                children: [new Paragraph({ children: [new TextRun({ text, bold: true })], alignment: AlignmentType.CENTER })]
            });
        }
        function createDataCell(text) {
            return new TableCell({
                children: [new Paragraph({ children: [new TextRun({ text })], alignment: AlignmentType.CENTER })]
            });
        }
        const headerCells = Array.from(headerRow.cells).map(cell => createHeaderCell(cell.innerText.trim()));
        const dataRows = rows.map(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            return new TableRow({
                children: cells.map(cell => {
                    const badge = cell.querySelector('.badge');
                    return createDataCell(badge ? badge.innerText.trim() : cell.innerText.trim());
                })
            });
        });
        const docTable = new Table({
            rows: [new TableRow({ children: headerCells }), ...dataRows]
        });
        const doc = new Document({
            sections: [{
                children: [
                    new Paragraph({ text: "Performance Task Report", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: `Generated on ${new Date().toLocaleDateString()}`, alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: "Filter Information", heading: HeadingLevel.HEADING_3 }),
                    new Paragraph({ text: `Grading Period: ${periodText}` }),
                    new Paragraph({ text: `Section: ${sectionText}` }),
                    new Paragraph({ text: `Search: ${searchText}` }),
                    docTable
                ]
            }]
        });
        Packer.toBlob(doc).then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Performance_Task_${periodText}_${sectionText}_${new Date().toISOString().split('T')[0]}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
});
</script>
{% endblock %}
